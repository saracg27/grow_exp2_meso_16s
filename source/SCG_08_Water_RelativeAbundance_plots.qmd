---
title: "SCG_08_Water_RelativeAbundance_plots"
author: "Sara Correa Garcia"
format: html
editor: source
---

------------------------------------------------------------------------
# LOAD PACKAGES & DATA
# ------------------------------------------------------------------------

## Packages

```{r}
library(here)
source(here("source", "libraries.R"))
```

## Metadata

```{r}
meta <- read.csv(file = here("data","raw", "18S", "metadata.tsv"), dec = ".", header = T, row.names = 1, sep = "\t", comment.char = "") #load
str(meta)
## Convert character vectors to factors
meta[sapply(meta, is.character)] <- lapply(meta[sapply(meta, is.character)], as.factor) # did it work? Check with str(meta)
#rownames(meta) <- sub(".*i5_", "", rownames(meta))
rownames(meta) <- stringr::str_replace_all(rownames(meta), '[-]', '.')
```

## 18S ASV table: Raw filtered counts

```{r}
raw <- read.csv(file = here("data", "raw", "18S", "Mesocosm_Water_18S_oct2023.ASV_table_norarefaction_dnNA.tsv"), dec = ".", sep = "\t", header = T, row.names = 1, comment.char = "") #850 objs in 142 vars
```

### Filter metadata samples
```{r}
raw <- raw[, order(colnames(raw))]
cols <- colnames(raw)
meta <- meta[rownames(meta) %in% cols, ]
```



Check library size
```{r}
raw_libsize <- as.data.frame(colSums(raw[,1:ncol(raw)-1]))
summary(raw_libsize)
```

There is one library that is too small: M7G.Jan.4.2022 with only 5 counts. The other samples are ok
 Min.   :    5                  
 1st Qu.:27821                  
 Median :31104                  
 Mean   :32618                  
 3rd Qu.:36566                  
 Max.   :54723  

Eliminate M7G.Jan.4.2022 from raw and metadata

```{r}
'M7G.Jan.4.2022' %in% colnames(raw)
raw <- raw[, colnames(raw) != 'M7G.Jan.4.2022']
meta <- meta[rownames(meta) != 'M7G.Jan.4.2022',]
```

tidy environment
```{r}
rm(list = c("cols", "raw_libsize", "taxonomy_col"))
```


------------------------------------------------------------------------

# CLEAN METADATA

# ------------------------------------------------------------------------

## Order metadata

```{r}
meta_sorted <- meta[order(row.names(meta)),] # order metadata 
#rownames(meta_sorted) 
str(meta_sorted) # 140 7 variables
```

## Keep interestig variables
```{r}
names(meta_sorted)
cols_to_keep <- c("Sample_type", "Time", "Temperature")
meta_sorted <- meta_sorted[, cols_to_keep]
levels(meta_sorted$Time)
```

## Recode variables for uniform presentation
```{r}
meta_sorted$Time <- factor(meta_sorted$Time, 
                           levels = c("D-0", "D8", "D15", "D34" ,"D61", "D77"),
                           labels = c("D0", "D10", "D16", "D35" ,"D62", "D78"))
meta_sorted$Sample_type <- factor(meta_sorted$Sample_type,
                                  levels = c("No_plant", "Scirpus", "Triglochin"), 
                                  labels = c("No_plant", "*Scirpus*", "*Triglochin*"))
meta_sorted$Temp <- factor(meta_sorted$Temperature,
                           levels = c("10C day - 5C night", "20C day - 10C night"),
                           labels = c("cold", "warm"))
```

# ------------------------------------------------------------------------

# TAXONOMY (RAW COUNTS)

# ------------------------------------------------------------------------

## Create tax_raw table for raw data

```{r}
dim(raw) # 850 141 OK
tax_raw <- as.data.frame(raw[,ncol(raw)]) # taxonomy obtained from last column as independent table
otuids <- rownames((raw))
rownames(tax_raw) <- otuids
names(tax_raw) <- c("taxonomy")
```

## Separate tax_raw into groups
```{r}
tax_raw_clean <- separate(tax_raw, taxonomy, into = c("Domain", "Phylum", "Class", "Order", "Family", "Genus", "Species", "Strain"), sep = ";")
tax_raw_clean <- tax_raw_clean[,-which(names(tax_raw_clean) %in% c("Species", "Strain"))]
tax_raw_clean <- as.data.frame(tax_raw_clean)
levels(as.factor(tax_raw_clean$Domain)) # 1 Domain: Eukaryota ok
levels(as.factor(tax_raw_clean$Phylum)) #  37 Phyla 
levels(as.factor(tax_raw_clean$Class)) # 59 classes
levels(as.factor(tax_raw_clean$Order)) # 80 orders
levels(as.factor(tax_raw_clean$Family)) # 85 Families
levels(as.factor(tax_raw_clean$Genus)) # 151 genus
str(tax_raw_clean)
```


## Clean taxonomy names
```{r}
# eliminate the characters  -----
pattern <- "[a-z]__"
replacement <- ""
tax_clean <- as.data.frame(apply(tax_raw_clean, 2, function(col) gsub(pattern, replacement, col)))
rm(pattern)
rm(replacement)
```

## Fill NAs with last available taxon rank
```{r}
tax_clean <- tax_clean |> 
   t() |> 
   as.data.frame() |> 
   fill(everything(), .direction = "down") |> 
   t() |> 
   as.data.frame()
#write.table(tax.clean, file = here::here("data", "clean", "clean_taxonomy.txt"),sep = "\t")
#rm(list = c("raw_libsize", "tax_raw", "tax_clean", "tax_raw_clean", "pattern", "replacement", "otuids", "cols_to_keep"))
```

### Tidy environment
```{r}
rm(list = c("otuids", "cols_to_keep", "tax_raw_clean", "meta"))
```

# ------------------------------------------------------------------------

# ABUNDANCE TABLES (RAW) - PHYLUM

# ------------------------------------------------------------------------

## Create clean count table no tax
```{r}
counts_clean_tax <- merge(raw, tax_clean, by = "row.names")
rownames(counts_clean_tax) <- counts_clean_tax$Row.names
counts_clean_tax$Row.names <- NULL
counts_clean_tax$taxonomy <- NULL
counts <- counts_clean_tax[ , sapply(counts_clean_tax, is.numeric)]
```

## Phylum
### Aggregate by phylum
```{r}
phylum <- cbind(counts_clean_tax$Phylum, counts)
names(phylum)[names(phylum) == "counts_clean_tax$Phylum"] <- "phylum"
phylum <- aggregate(. ~ phylum, data = phylum, sum)
rowSums(phylum[,2:ncol(phylum)])

str(phylum)
rownames(phylum) <- phylum$phylum # set row names with first column containing phylum names
phylum$phylum <- NULL # remove column with tax rank
phylum <- as.matrix(t(phylum)) # transpose
```

### Aggregate by class 
```{r}
class <- cbind(counts_clean_tax$Class, counts)
names(class)[names(class) == "counts_clean_tax$Class"] <- "class"
class <- aggregate(. ~ class, data = class, sum)
str(class)
rownames(class) <- class$class # set row names with first column containing class names
class$class <- NULL # remove column with tax rank
class <- as.matrix(t(class)) 
```

## Genus
### Aggregate table
```{r}
genus <- cbind(counts_clean_tax$Genus, counts)
names(genus)[names(genus) == "counts_clean_tax$Genus"] <- "genus"
genus <- aggregate(. ~ genus, data = genus, sum)
rownames(genus) <- genus$genus # set row names with first column containing genus names
genus$genus <- NULL # remove column with tax rank
genus <- as.matrix(t(genus)) # transpose
```

### Aggregate table from raw tax
```{#r}
genus <- cbind(tax_raw$taxonomy, counts)
names(genus)[names(genus) == "tax_raw$taxonomy"] <- "genus"
genus <- aggregate(. ~ genus, data = genus, sum)
rownames(genus) <- genus$genus # set row names with first column containing genus names
genus$genus <- NULL # remove column with tax rank
genus <- as.matrix(t(genus)) # transpose
```

## Calculate relative abundances
```{r}
genus_rel <- (genus/rowSums(genus))
#Check
if (all(round(rowSums(genus_rel),6) == 1)) { #Sanity check all 1 - round() reduces the risk of floating-point errors
  print("Sanity check ok = all sum to 1")
} else {
  print("ERROR: not all columns sum to 1")
}
#Check
phylum_rel <- (phylum/rowSums(phylum))
if (all(round(rowSums(phylum_rel),6) == 1)) { #Sanity check all 1 - round() reduces the risk of floating-point errors
  print("Sanity check ok = all sum to 1")
} else {
  print("ERROR: not all columns sum to 1")
}
```

## Order by row names
```{r}
meta_sorted <- meta_sorted[order(row.names(meta_sorted)),] 
phylum_sorted <- phylum_rel[order(row.names(phylum_rel)),] 
genus_sorted <- genus_rel[order(row.names(genus_rel)),] # order 

# Sanity check for phylum
if (all(row.names(meta_sorted) == rownames(phylum_sorted) )) {
  print("Sanity check ok")
} else {
  print("ERROR: not all row names are the same")
}

# Sanity check for genus
if (all(row.names(meta_sorted) == rownames(genus_sorted) )) {
  print("Sanity check ok")
} else {
  print("ERROR: not all row names are the same")
}

```


## Export tax rank abundance tables
```{r}
save(meta_sorted, phylum_sorted, genus_sorted, file = here::here("RData", "RelAbund_tables.RData"))
```


# ------------------------------------------------------------------------

# ABUNDANCE TABLES (RAW)

# ------------------------------------------------------------------------

## Transpose

```{r}
com_raw <- raw[,1:(ncol(raw)-1)] # create community table with asv table with only abundances not taxonomy
com_raw_t = t(com_raw) # transposing table, samples as rows, species as columns to match metadata
```

## Keep only defined treatments as in metadata

```{r}
com_raw_s <- com_raw_t[rownames(com_raw_t) %in% rownames(meta_sorted),]
meta_sorted <- meta_sorted[rownames(meta_sorted) %in% rownames(com_raw_s),]
```

## Order table and check

```{r}
com_raw_sorted <- com_raw_s[order(row.names(com_raw_s)),]
rownames(meta_sorted) == rownames(com_raw_sorted)
```


## Remove low abundances

```{r}
phylum <- phylum_sorted

colsums_phylum <- as.data.frame(colSums(phylum_sorted))
sum(colsums_phylum$`colSums(phylum_sorted)` == 0) # 0 phylum have a relative abundance of 0 in water  samples


abund <- as.data.frame(phylum[, colMeans(phylum) > 0.01]) # 10
abund$Others = 1 - rowSums(abund)#Add an "Other" category
colnames(abund) # there are empty spaces in column names
colnames(abund) <- gsub(" ", "", colnames(abund)) # trim empty spaces
```

Only 8 phyla had a relative abundance higher than 1%: Centrohelida, Chlorophyta, Ciliophora, Cryptomycota, Nematozoa, Ochrophyta, Rotifera, Eukaryota and Others (all other low abundance phyla). 


## Bind treatments and abundances
```{r}

rownames(abund) == rownames(meta_sorted)
abund_treat = cbind(meta_sorted,abund)
dim(abund_treat) # 140 13
```

## Gather in long format for ggplot

```{r}
long <- gather(abund_treat,Taxa,RelAbund,5:ncol(abund_treat)) #change the column index value to match the first column that contains a Taxa name and not a treatment
head(long) # It looks ok!
phylum_long <- long
```

# -------------------------------------------------------

# STACKED BARS PHYLUM

# -------------------------------------------------------


## Color palette

```{r}
pal3 <- c("#F2D696","#BDFFF0","#F59C9B","#71ACD6","#7B9E81","#CDC0B0","#968EC2","#B2D2E8","#F7C6EC", "#C7DBC5","#C1CDCD")
```

## Create the stack bar chart
## Warmen plot
```{r}
## Relevel groups to put the largest group at the bottom, and the second largest at the top
phylum_long$Taxa <- fct_relevel(phylum_long$Taxa, "Others", after = 0L)
phylum_long$Taxa <- fct_relevel(phylum_long$Taxa, "Chlorophyta", after = Inf)
phylum_long$Time <- factor(x = phylum_long$Time, levels = c("D0", "D10", "D16", "D35","D62","D78"), labels = c("0", "10", "16", "35", "62", "78"))

warm <- droplevels(phylum_long[phylum_long$Temp == "warm",])


stack_phylum_warm <- ggplot(warm, aes(fill = Taxa, y = RelAbund, x = Time)) + 
  geom_bar(stat = "identity", position = "fill") +
  labs( y = "Relative abundance",
        title = "20\u00B0C day / 10\u00B0C night") + 
  theme_minimal() +
  theme(strip.text.x = element_text(face = "bold.italic", size = 16),
        axis.text.x = element_text(size = 12, angle = 360, hjust = 0.5, face = "bold"),
        axis.text.y = element_text(size = 12, face = "bold"),
        plot.title = element_text(face = "bold", size = 16),
        legend.title = element_text(size = 14, color = "black", face = "bold"),
        legend.text = element_text(size = 10, face ="bold", color ="black"),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.title.x = element_blank(),
        legend.position = "none",
        rect = element_rect(fill = "white")) +
  scale_fill_manual(values = pal3, guide = guide_legend(label.theme = element_text(face = "italic", size = 12))) +
  scale_color_manual(values = pal3, guide = guide_legend(label.theme = element_text(face = "italic", size = 12))) +
  facet_grid(.~ Sample_type,  scales = "free_x", space = "free_x") + 
  scale_y_continuous(limits = c(0,1), expand = c(0,0)) 
  #scale_x_discrete(name = "Time in days since OSPW introduction")

stack_phylum_warm
```

## Cold plot
```{r}
cold <- droplevels(phylum_long[phylum_long$Temp == "cold",])

stack_phylum_cold <- ggplot(cold, aes(fill = Taxa, y = RelAbund, x = Time)) + 
  geom_bar(stat = "identity", position = "fill") +
  labs( y = "Relative abundance",
        title = "10\u00B0C day / 5\u00B0C night") + 
  theme_minimal() +
  theme(strip.text.x = element_text(face = "bold.italic", size = 16),
        axis.text.x = element_text(size = 12, angle = 360, hjust = 0.5, face = "bold"),
        axis.text.y = element_text(size = 12, face = "bold"),
        plot.title = element_text(face = "bold", size = 16),
        legend.title = element_text(size = 14, color = "black", face = "bold"),
        legend.text = element_text(size = 10, face ="bold", color ="black"),
        legend.position = "none",
        axis.title = element_text(size = 16, face = "bold"),
        rect = element_rect(fill = "white")) +
  scale_fill_manual(values = pal3, guide = guide_legend(label.theme = element_text(face = "italic", size = 12))) +
  scale_color_manual(values = pal3, guide = guide_legend(label.theme = element_text(face = "italic", size = 12))) +
  facet_grid(.~ Sample_type,  scales = "free_x", space = "free_x") + 
  scale_y_continuous(limits = c(0,1), expand = c(0,0)) +
  scale_x_discrete(name = "Time in days since OSPW introduction")

stack_phylum_cold
#Get legend
```

## Legend
```{r}
legend <- get_legend(ggplot(cold, aes(fill = Taxa, y = RelAbund, x = Time)) + 
  geom_bar(stat = "identity", position = "fill") + 
      scale_fill_manual(values = pal3, guide = guide_legend(label.theme = element_text(face = "italic", size = 12))) +
  scale_color_manual(values = pal3, guide = guide_legend(label.theme = element_text(face = "italic", size = 12))) +
  theme(strip.text.x = element_text(face = "bold.italic", size = 16),
        axis.text.x = element_text(size = 12, angle = 360, hjust = 0.5, face = "bold"),
        axis.text.y = element_text(size = 12, face = "bold"),
        plot.title = element_text(face = "bold", size = 16),
        legend.title = element_text(size = 14, color = "black", face = "bold"),
        legend.text = element_text(size = 10, face ="bold", color ="black"),
        axis.title = element_text(size = 16, face = "bold"),
        rect = element_rect(fill = "white")))
```

## Combine plots
```{r}
combined_plot <- ggdraw() +
  draw_plot(stack_phylum_warm, x = 0, y = 0.5, width = 0.8, height = 0.5) +
  draw_plot(stack_phylum_cold, x = 0, y = 0, width = 0.8, height = 0.5) +
  draw_plot(legend, x = 0.75, y = 0.25, width = 0.3, height = 0.5) +
  draw_label("A)", x = 0.02, y = 0.98, size = 17, fontface ="bold") +  
  draw_label("B)", x = 0.02, y = 0.48, size = 17, fontface ="bold") 
combined_plot
```

Run only once
```{#r}
#Save plots
ggsave(file = here::here("output", "figures", "relAbund_phylum_18S_waters.pdf"), combined_plot, width = 11, height = 8, units = "in", dpi = 300,bg = "white")
ggsave(file = here::here("output", "figures", "relAbund_phylum_18S_waters.eps"), combined_plot, width = 11, height = 8, units = "in", dpi = 300,bg = "white")
ggsave(file = here::here("output", "figures", "relAbund_phylum_18S_waters.png"), combined_plot, width = 11, height = 8, units = "in", dpi = 300,bg = "white")
```


# -------------------------------------------------------

# DATA WRANGLING - GENUS

# -------------------------------------------------------

## Remove low abundances

```{r}
genus <- genus_sorted
dim(genus) # 140 191
colsums_genus <- as.data.frame(colSums(genus_sorted))
sum(colsums_genus$`colSums(genus_w)` == 0) # 0 genera have a relative abundance of 0 in water  samples
abund <- as.data.frame(genus[, colMeans(genus) > 0.005]) # 19 genera with a relative abundance over 0.5%
abund$Others = 1 - rowSums(abund)#Add an "Other" category
colnames(abund) # there are empty spaces in column names
colnames(abund) <- gsub(" ", "", colnames(abund)) # trim empty spaces
```

## Bind treatments and abundances
```{r}
treat <- meta_sorted
rownames(abund) == rownames(treat)
abund_treat = cbind(treat,abund)
dim(abund_treat) # 140 24
```

## Gather in long format for ggplot

```{r}
long <- gather(abund_treat,Taxa,RelAbund,5:ncol(abund_treat)) #change the column index value to match the first column that contains a Taxa name and not a treatment
head(long) # It looks ok!
genus_long <- long
```

### Clean taxonomy values

### Create tax_raw table for raw data

```{r}
dim(genus_long) # 4440    6 OK
str(genus_long)
genus_long$Taxa <- as.factor(genus_long$Taxa)
genus_long$Taxa <- factor(genus_long$Taxa,
                          levels = c("Chlamydomonas", 
                                     "Chlorococcum",
                                     "Chlorophyceae", "Choanocystis",
                                     "Chromulinales","Eukaryota",
                                     "Freshwater_Choanoflagellates_1", 
                                     "Heterophrys", "Hypotrichia",
                                     "LKM11", "Mychonastes",
                                     "Ochromonas", "Others", 
                                     "Picochlorum", "Plectus", 
                                     "Ploimida", "Poterioochromonas",
                                     "Spumella", "Spumella-like",
                                     "Trebouxiophyceae"),
                          labels = c("*Chlamydomonas*", 
                                     "*Chlorococcum*",
                                     "*Chlorophyceae*", "*Choanocystis*",
                                     "*Chromulinales*","*Eukaryota*",
                                     "*Choanoflagellates 1*", 
                                     "*Heterophrys*", "*Hypotrichia*",
                                     "*LKM11*", "*Mychonastes*",
                                     "*Ochromonas*", "Others", 
                                     "*Picochlorum*", "*Plectus*", 
                                     "*Ploimida*", "*Poterioochromonas*",
                                     "*Spumella*", "*Spumella* - like",
                                     "*Trebouxiophyceae*"))

```

## Create the lolipop chart
```{r}
# Step 1: Calculate the mean values with ave()
mean_values <- ave(genus_long$RelAbund, genus_long$Time, genus_long$Taxa, FUN = mean)

# Reorder the levels baw on mean values
genus_long$Taxa <- reorder(genus_long$Taxa, mean_values, FUN = mean)

# Add small value to prevent inf error when log transforming
genus_long$RelAbund <- genus_long$RelAbund + 1e-6
#genus_long$Sample_type <- factor(genus_long$Sample_type, levels = c("no_plant", "Scirpus", "Triglochin"),labels = c("no plant", "*Scirpus*", "*Triglochin*") )

#high_contrast = c("#FF8C00","#440154", "#CD0000","#545361FF", "#009ACD") 
viridis::magma(7, alpha = 1) # extract colors from magma to match naphthenic acid figure PCA
#"#000004FF" "#2D1160FF" "#721F81FF" "#B63679FF" "#F1605DFF" "#FEAF77FF" "#FCFDBFFF"
high_contrast <- c("#000004FF", "#721F81FF" ,"#B63679FF" ,"#F1605DFF", "#FEAF77FF", "#FCFDBFFF") 
# Step 3: Create the plot
p1 <- ggplot(data = genus_long, aes(y = Taxa, x = RelAbund, color = Time)) +
    geom_vline(xintercept = c(0.001, 0.01, 0.1, 0.4), color = "lightgrey", linewidth = 0.1) +
  stat_summary(fun.data = median_hilow, geom = "pointrange", fun.args = list(conf.int = 0.5),
               position = position_dodge(width = 0.4),
               linewidth = 0.25) +
  coord_trans(x = "log10") +
    ylab("Taxonomic group") + 
    xlab("log10 Relative abundance") +
    scale_color_manual(values = high_contrast) + 
  theme_classic() +
  theme(
    axis.text.y = element_markdown(),
    legend.text = element_markdown(),
    legend.title = element_blank(),
    legend.position = "bottom",
    legend.spacing = unit(0.1, "cm"),
    #legend.position = c(0.92, 0.15),
    legend.background = element_rect(color = "darkgrey", fill = "white"),
    #legend.margin = margin(t = -5, r = 3, b = 3),
    strip.text.x = element_markdown(size = 12),
    strip.text.y = element_markdown(size = 12)
    
  ) +
    
    scale_x_continuous(limits = c(NA, 1.5), 
                       breaks = c(0.001,0.01, 0.1, 0.4),
                       labels = c(".001", ".01", ".1", ".4")) +
  facet_grid(Temperature ~ Sample_type)

p1

# Save plots
#ggsave(file = here::here("output", "figures", "relAbund_genus_16S_waters_pops.pdf"), p1, width = 9, height = 11, units = "in", dpi = 300,bg = "white")
#ggsave(file = here::here("output", "figures", "relAbund_genus_16S_waters_pops.eps"), p1, width = 9, height = 11, units = "in", dpi = 300,bg = "white")
# ggsave(file = here::here("output", "figures", "relAbund_genus_18S_waters_pops.png"), p1, width = 9, height = 11, units = "in", dpi = 300,bg = "white")
```


# -------------------------------------------------------

# TOP 10 genera

# -------------------------------------------------------
## Remove low abundances

```{r}
abund <- as.data.frame(genus[, colMeans(genus) > 0.01]) # 12 genera with a relative abundance over 1%
abund$Others = 1 - rowSums(abund)#Add an "Other" category
colnames(abund) # there are empty spaces in column names
colnames(abund) <- gsub(" ", "", colnames(abund)) # trim empty spaces
```

## Bind treatments and abundances
```{r}
treat <- meta_sorted
rownames(abund) == rownames(treat)
abund_treat <- cbind(treat,abund)
dim(abund_treat) # 140 17
```

## Gather in long format for ggplot

```{r}
long <- gather(abund_treat,Taxa,RelAbund,5:ncol(abund_treat)) #change the column index value to match the first column that contains a Taxa name and not a treatment
head(long) # It looks ok!
genus_long <- long
```

### Clean taxonomy values

```{r}
levels(as.factor(genus_long$Taxa)) 
dim(genus_long) # 1820 6 OK

str(genus_long)
genus_long$Taxa <- as.factor(genus_long$Taxa)
genus_long$Taxa <- factor(genus_long$Taxa,
                          levels = c("Chlorococcum",
                                     "Chlorophyceae", 
                                     "Eukaryota",
                                     "Heterophrys", 
                                     "LKM11", 
                                     "Mychonastes",
                                     "Others", 
                                     "Picochlorum", 
                                     "Plectus", 
                                     "Ploimida", 
                                     "Poterioochromonas",
                                     "Spumella-like",
                                     "Trebouxiophyceae"),
                          labels = c("*Chlorococcum*",
                                     "*Chlorophyceae*", 
                                     "*Eukaryota*",
                                     "*Heterophrys*", 
                                     "*LKM11*", 
                                     "*Mychonastes*",
                                     "Others", 
                                     "*Picochlorum*",
                                     "*Plectus*", 
                                     "*Ploimida*",
                                     "*Poterioochromonas*",
                                     "*Spumella* - like",
                                     "*Trebouxiophyceae*"))

```

## Create the lolipop chart contrast time
```{r}

# Step 1: Calculate the mean values with ave()
is.numeric(genus_long$RelAbund)
mean_values <- ave(genus_long$RelAbund, genus_long$Taxa, FUN = mean)

# Reorder the levels baw on mean values
genus_long$Taxa <- reorder(genus_long$Taxa, mean_values, FUN = mean)

# Add small value to prevent inf error when log transforming
genus_long$RelAbund <- genus_long$RelAbund + 1e-6
#genus_long$Sample_type <- factor(genus_long$Sample_type, levels = c("No_plant", "Scirpus", "Triglochin"), labels = c("no plant", "*Scirpus*", "*Triglochin*") )


#viridis::magma(7, alpha = 1) # extract colors from magma to match naphthenic acid figure PCA
#"#000004FF" "#2D1160FF" "#721F81FF" "#B63679FF" "#F1605DFF" "#FEAF77FF" "#FCFDBFFF"
#high_contrast <- c("#000004FF", "#721F81FF" ,"#B63679FF" ,"#F1605DFF", "#FEAF77FF") 
high_contrast <- c("#000004FF", "#2D1160FF" ,"#721F81FF","#B63679FF", "#F1605DFF" ,"#FEAF77FF" ,"#FCFDBFFF") 
# Step 3: Create the plot
p2 <- ggplot(data = genus_long, aes(y = Taxa, x = RelAbund, color = Time)) +
    geom_vline(xintercept = c(0.001, 0.01, 0.1, 0.4), color = "lightgrey", size = 0.1) +
  stat_summary(fun.data = median_hilow, geom = "pointrange", fun.args = list(conf.int = 0.5),
               position = position_dodge(width = 0.4),
               linewidth = 0.25) +
  coord_trans(x = "log10") +
    ylab("Taxonomic group") + 
    xlab("log10 Relative abundance") +
    scale_color_manual(values = high_contrast) + 
  theme_classic() +
  theme(
    axis.text.y = element_markdown(),
    legend.text = element_markdown(),
    legend.title = element_blank(),
    legend.position = "bottom",
    legend.spacing = unit(0.1, "cm"),
    #legend.position = c(0.92, 0.15),
    legend.background = element_rect(color = "darkgrey", fill = "white"),
    #legend.margin = margin(t = -5, r = 3, b = 3),
    strip.text.x = element_markdown(size = 12),
    strip.text.y = element_markdown(size = 12)
    
  ) +
    
    scale_x_continuous(limits = c(NA, 1.5), 
                       breaks = c(0.001,0.01, 0.1, 0.4),
                       labels = c(".001", ".01", ".1", ".4")) +
  facet_grid(Temperature ~ Sample_type )

p2

# Save plots
ggsave(file = here::here("output", "figures", "relAbund_genus_18S_waters_pops_0.01top_time_effect.pdf"), p2, width = 9, height = 11, units = "in", dpi = 300,bg = "white")
ggsave(file = here::here("output", "figures", "relAbund_genus_18S_waters_pops0.01top_time_effect.eps"), p2, width = 9, height = 11, units = "in", dpi = 300,bg = "white")
ggsave(file = here::here("output", "figures", "relAbund_genus_18S_waters_pops0.01top_time_effect.png"), p2, width = 9, height = 11, units = "in", dpi = 300,bg = "white")
```


# -------------------------------------------------------

# STACKED BARS GENUS

# -------------------------------------------------------


## Color palette

```{r}
pal3 <- c("#F2D696","#BDFFF0","#F59C9B","#71ACD6","#7B9E81","#CDC0B0","#968EC2","#B2D2E8","#F7C6EC", "#C7DBC5","#C1CDCD", "#721F81FF","#B63679FF")
```

## Create the stack bar chart

## Recode 18S samples: 
```{r}
genus_long$Taxa <- factor(genus_long$Taxa,
                          levels = c("*Chlorococcum*",
                                     "*Chlorophyceae*", 
                                     "*Eukaryota*",
                                     "*Heterophrys*", 
                                     "*LKM11*", 
                                     "*Mychonastes*",
                                     "Others", 
                                     "*Picochlorum*",
                                     "*Plectus*", 
                                     "*Ploimida*",
                                     "*Poterioochromonas*",
                                     "*Spumella* - like",
                                     "*Trebouxiophyceae*"),
                          labels =  c("Chlorococcum",
                                     "Chlorophyceae", 
                                     "Eukaryota",
                                     "Heterophrys", 
                                     "LKM11", 
                                     "Mychonastes",
                                     "Others", 
                                     "Picochlorum", 
                                     "Plectus", 
                                     "Ploimida", 
                                     "Poterioochromonas",
                                     "Spumella-like",
                                     "Trebouxiophyceae"))
```

## Warm plot
```{r}
## Relevel groups to put the largest group at the bottom, and the second largest at the top
genus_long$Taxa <- fct_relevel(genus_long$Taxa, "Chlorophyceae", after = 0L)
genus_long$Taxa <- fct_relevel(genus_long$Taxa, "Trebouxiophyceae", after = Inf)
genus_long$Time <- factor(x = genus_long$Time, levels = c("D0", "D10", "D16", "D35","D62","D78"), labels = c("0", "10", "16", "35", "62", "78"))

warm <- droplevels(genus_long[genus_long$Temp == "warm",])


stack_genus_warm <- ggplot(warm, aes(fill = Taxa, y = RelAbund, x = Time)) + 
  geom_bar(stat = "identity", position = "fill") +
  labs( y = "Relative abundance",
        title = "20\u00B0C day / 10\u00B0C night") + 
  theme_minimal() +
  theme(#strip.text.x = element_text(face = "bold.italic", size = 16),
        strip.text.x = element_markdown(size = 16, face = "bold"),
        axis.text.x = element_text(size = 12, angle = 360, hjust = 0.5, face = "bold"),
        axis.text.y = element_text(size = 12, face = "bold"),
        plot.title = element_text(face = "bold", size = 16),
        legend.title = element_text(size = 14, color = "black", face = "bold"),
        legend.text = element_markdown(size = 10),
        #legend.text = element_text(size = 10, face ="bold", color ="black"),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.title.x = element_blank(),
        legend.position = "none",
        rect = element_rect(fill = "white")) +
  scale_fill_manual(values = pal3, guide = guide_legend(label.theme = element_text(face = "italic", size = 12))) +
  scale_color_manual(values = pal3, guide = guide_legend(label.theme = element_text(face = "italic", size = 12))) +
  facet_grid(.~ Sample_type,  scales = "free_x", space = "free_x") + 
  scale_y_continuous(limits = c(0,1), expand = c(0,0)) 
  #scale_x_discrete(name = "Time in days since OSPW introduction")

stack_genus_warm
```

## Cold plot
```{r}
cold <- droplevels(genus_long[genus_long$Temp == "cold",])

stack_genus_cold <- ggplot(cold, aes(fill = Taxa, y = RelAbund, x = Time)) + 
  geom_bar(stat = "identity", position = "fill") +
  labs( y = "Relative abundance",
        title = "10\u00B0C day / 5\u00B0C night") + 
  theme_minimal() +
  theme(#strip.text.x = element_text(face = "bold.italic", size = 16),
        strip.text.x = element_markdown(size = 16, face = "bold"),
        axis.text.x = element_text(size = 12, angle = 360, hjust = 0.5, face = "bold"),
        axis.text.y = element_text(size = 12, face = "bold"),
        plot.title = element_text(face = "bold", size = 16),
        legend.title = element_text(size = 14, color = "black", face = "bold"),
        #legend.text = element_text(size = 10, face ="bold", color ="black"),
        legend.text = element_markdown(size = 10),
        legend.position = "none",
        axis.title = element_text(size = 16, face = "bold"),
        rect = element_rect(fill = "white")) +
  scale_fill_manual(values = pal3, guide = guide_legend(label.theme = element_text(face = "italic", size = 12))) +
  scale_color_manual(values = pal3, guide = guide_legend(label.theme = element_text(face = "italic", size = 12))) +
  facet_grid(.~ Sample_type,  scales = "free_x", space = "free_x") + 
  scale_y_continuous(limits = c(0,1), expand = c(0,0)) +
  scale_x_discrete(name = "Time in days since OSPW introduction")

stack_genus_cold
#Get legend
```

## Legend
```{r}
legend <- get_legend(ggplot(cold, aes(fill = Taxa, y = RelAbund, x = Time)) + 
  geom_bar(stat = "identity", position = "fill") + 
      scale_fill_manual(values = pal3, guide = guide_legend(label.theme = element_text(face = "italic", size = 12))) +
  scale_color_manual(values = pal3, guide = guide_legend(label.theme = element_text(face = "italic", size = 12))) +
  theme(strip.text.x = element_text(face = "bold.italic", size = 16),
        axis.text.x = element_text(size = 12, angle = 360, hjust = 0.5, face = "bold"),
        axis.text.y = element_text(size = 12, face = "bold"),
        plot.title = element_text(face = "bold", size = 16),
        legend.title = element_text(size = 14, color = "black", face = "bold"),
        legend.text = element_text(size = 10, face ="bold", color ="black"),
        axis.title = element_text(size = 16, face = "bold"),
        rect = element_rect(fill = "white")))
legend
```

## Combine plots
```{r}
combined_plot <- ggdraw() +
  draw_plot(stack_genus_warm, x = 0, y = 0.5, width = 0.8, height = 0.5) +
  draw_plot(stack_genus_cold, x = 0, y = 0, width = 0.8, height = 0.5) +
  draw_plot(legend, x = 0.75, y = 0.25, width = 0.3, height = 0.5) +
  draw_label("A)", x = 0.02, y = 0.98, size = 17, fontface ="bold") +  
  draw_label("B)", x = 0.02, y = 0.48, size = 17, fontface ="bold") 
combined_plot
```

Run only once
```{#r}
#Save plots
ggsave(file = here::here("output", "figures", "relAbund_genus_18S_waters.pdf"), combined_plot, width = 11, height = 8, units = "in", dpi = 300,bg = "white")
ggsave(file = here::here("output", "figures", "relAbund_genus_18S_waters.eps"), combined_plot, width = 11, height = 8, units = "in", dpi = 300,bg = "white")
ggsave(file = here::here("output", "figures", "relAbund_genus_18S_waters.png"), combined_plot, width = 11, height = 8, units = "in", dpi = 300,bg = "white")
```

